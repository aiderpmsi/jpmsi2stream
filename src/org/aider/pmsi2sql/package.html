<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>

</head>
<body bgcolor="white">

Permet d'insérer des fichiers PMSI (RSF et RSS) dans une base de données PostgreSQL. 

Deux applications sont générées :

<ul>
<li> pmsi2sqlcreate : crée les tables nécessaires à l'insertion des données de PMSI</li>
<li> pmsi2sql : insère un fichier PMSI (RSF ou RSS) dans la base de données ; le type de fichier est détecté de manière automatique</li>
</ul>

<h2>Package Specification</h2>

<ol class="niveau1">
  <li>Présentation générale de la solution</li>
	<ol class="niveau2">
  	  <li>Langage de programmation : JAVA</li>
        Permet de s'interfacer avec les servlets, multiplateforme.
  	  <li>Base de données : Postgresql</li>
        Très bonne compliance au standard SQL, nombreuses fonctionnalités simplifiant le développement.
  	  <li>Absence de fichiers de configuration</li>
  	    Permet de définir tous les paramètres en ligne de commande. Attention, risque de sécurité car le mot de passe de la bd peut apparaitre dans la liste des processus.
    </ol>

  <li>Spécifications fonctionnelles</li>
	Permet d'insérer des données d'un RSS version 6 ou d'un RSF type nouveau format dans une base de données PostgreSQL
	afin de permettre des requêtes personnalisées et l'utilisation d'outils de reporting. 
	<ol class="niveau2">
  	  <li>Environnement à utiliser</li>
        <div>
   	    La connexion à la base de données se fait de manière non sécurisée, le mot de passe peut se voir dans la
        liste des processus, il faut donc utiliser un environnement sécurisé avec des utilisateurs formés.
        </div>
        <div>
        La version de java utilisée pour le développement est java 1.6 ; toute autre version 6 de java devrait
        fonctionner, mais ce n'est pas testé.
        </div>
        <div>
        La version de postgresql utilisée pour le développement est la 9.1, mais toute version supérieure ou
        égale à la 9.0 devrait fonctionner. La base de données dans laquelle les données vont être insérées
        et l'utilisateur de la base de données doivent être créés en dehors de l'application avec les outils
        d'administration adéquats (par exemple pgadminIII).
        </div>
      <li>Exécution de l'application</li>
        Il existe deux exécutables : jpmsi2sqlcreate crée les tables dans la base de données, et
        jpmsi2sql insère les données d'un fichier pmsi dans ces tables de la base de données. jpmsi2sqlcreate.jar
        doit donc être appelé avant toute insertion de données.
        L'application peut être lancée dans n'importe quel répertoire.
        <ol class="niveau3">
          <li>jpmsi2sqlcreate.jar</li>
            Exécuter jpmsi2sqlcreate.jar avec l'argument <code>-h</code> affiche la liste des paramètres de l'application :
            <code><br/>
C:\Documents and Settings\delabre\Mes documents>java -jar jpmsi2sqlcreate.jar -h<br/>
 -dbh (--dbhost) HOST    : Specifie l'hôte de la base de données<br/>
 -dbn (--dbname) NAME    : Specifie le nom de la base de données à utiliser<br/>
 -dbp (--dbpassword) PWD : Specifie le mot de passe de l'utilisateur<br/>
 -dbu (--dbuser) USER    : Specifie l'utilisateur de la base de données<br/>
 -h (--help)             : Affiche l'aide<br/>
 -l (--logfile) FILE     : Specifie le fichier de trace (non utilisé)<br/>
 -p (--port) PORT        : Specifie le port de la base de données<br/>
 -v (--version)          : Affiche la version<br/>
 	        </code>
 	        Le schéma de base de données généré ne sera pas entièrement complet, mais permettra d'insérer
 	        les données des RSF et RSS dans la base de données. Il manquera la fonction d'historisation
 	        à rajouter par un script sql manuellement.
 	      <li>pmsi2sql.jar</li>
 	        Exécuter jpmsi2sql.jar avec l'argument <code>-h</code> affiche la liste des paramètres de l'application :
 	        <code><br/>
C:\Documents and Settings\delabre\Mes documents>java -jar jpmsi2sql.jar -h<br/>
 -dbh (--dbhost) HOST    : Specifie l'hôte de la base de données<br/>
 -dbn (--dbname) NAME    : Specifie le nom de la base de données à utiliser<br/>
 -dbp (--dbpassword) PWD : Specifie le mot de passe de l'utilisateur<br/>
 -dbu (--dbuser) USER    : Specifie l'utilisateur de la base de données<br/>
 -f (--file) FILE        : Specifie le fichier de PMSI à insérer<br/>
 -h (--help)             : Affiche l'aide<br/>
 -l (--logfile) FILE     : Specifie le fichier de trace (non utilisé)<br/>
 -p (--port) PORT        : Specifie le port de la base de données<br/>
 -v (--version)          : Affiche la version<br/>
            </code>
 	        L'insertion d'un RSF ou RSS dans la base de données se fait en indiquant le chemin du
 	        fichier à l'argument <code>-f</code>. Le type de fichier pmsi est détecté de manière automatique.
 	        Plusieurs fichiers PMSI peuvent être insérés pour un même Finess et une même période donnée, 
 	        l'ordre de classement pour prendre en compte le fichier valide consiste à prendre le dernier
 	        inséré parmi ceux qui n'ont pas été invalidés dans la table d'invalidation.
 	      <li>Création des tables et outils d'historisation</li>
 	        Le script <code>Invalisation.sql</code> crée une table listant les RSF ou RSS invalidés, organisés par date.
 	        La vue V_Admin_RSFHeader_Valides liste les dernières versions utilisées des RSF au moment où la requête est
   	        effectuée. La requête V_Admin_RSFHeader_getValides renvoie toutes les versions des RSF existants à un moment
 	        défini comme argument de la fonction, avec leur état : en cours d'utilisation, invalidé (ou ni l'un ni l'autre).
 	        La vue V_Admin_RSSHeader_Valides liste les dernières versions utilisées des RSS au moment où la requête est
 	        effectuée. La requête V_Admin_RSSHeader_getValides renvoie toutes les versions des RSS existants à un moment
 	        défini comme argument de la fonction, avec leur état : en cours d'utilisation, invalidé (ou ni l'un ni l'autre).
 	      <li>En cas d'erreur au cours de l'exécution du programme</li>
 	        Les messages d'erreur ne sont pas encore définis de manière correcte. Le fichier de log devrait petre utilisé
 	        pour tracer toutes les erreurs, sauf l'impossibilité à accéder à ce fichier qui devrait d'afficher sur la
 	        sortie standard.
        </ol>
    </ol>
    <li>Spécifications techniques</li>
    <ol class="niveau2">
      <li>Liens entre les tables de la base de données</li>
        Les foreign keys permettent de garantir la cohérence des tables. Le principe est le suivant :
          <ol class="standard">
            <li>Sauvegarde du fichier dans la table pmsiinsertion : chaque fichier pour lequel une tentative d'insertion
              dans la base de données est réalisé est enregistré dans cette table. Les champs permettant de définir
              la réussite ou l'échec de l'insertion sont laissés à null et ne seron remplis qu'à la fin du programme</li>
            <li>Selon le type de fichier, l'entête du fichier est enregistrée dans rsfheader ou rssheader, avec un lien
              vers la table pmsiinsertion : </li>
                <ul>
                  <li>Pour les fichiers RSF :</li>
                    <ol>
                      <li>Chaque ligne A du RSF est enregistrée avec un lien vers le fichier entête rsfheader. L'association
                        id de l'entête + numéro de facture doit être unique</li>
                      <li>Les autres lignes sont enregistrées avec un lien vers la ligne A correspondant au numéro de facture,
                        la clef étrangère est une clef multiple associant rsfheaderid et numéro de facture</li>
                    </ol>
                  <li>Pour les fichiers RSS :</li>
                    <ol>
                      <li>Chaque début de ligne (avec diagnostic principal) est enregistré dans la table RSSMain</li>
                      <li>Puis chaque diagnostic associé, documentaire ou acte est enregistré dans la table correspondante
                        avec un lien vers l'identifiant du diagnostic principal associé</li>
                    </ol>
                </ul>
	        <li>Si la tentative d'insertion a été une réussite, le statut de l'insertion (réussi ou non) est
	          stocké dans la table pmsiinsertion</li>
	      </ol>
	  <li>Transformation des données pour sauvegarde dans la base de données</li>
	    Les données des fichiers de PMSI sont séparées en 3 groupes :
	      <ul>
	        <li>numeric : stockée 'null' si vide</li>
	        <li>date : stockée 'null' si vide, transformée pour correspondre au format de date (yyyy-MM-dd)</li>
	        <li>chaine de caractères : chaine de caractère vide acceptée, pas de valeurs null possibles</li>
	      </ul>
    </ol>
  <li>Limitations</li>
    <ol class="niveau2">
      <li>Arguments de la ligne de commande</li>
        Les arguments de la ligne de commande ne sont pas échappés et peuvent entraîner des problèmes de sécurité.
        La présence dans la liste des processus du mot de passe de la base de données peut compromettre sa sécurité.
    </ol>
</ol> 

<h2> Schéma de la base de données </h2>
<img src="doc-files/pmsi2sql.png" alt="schéma de la base de données"/>

<h2>Related Documentation</h2>

<h2> License </h2>
Les Bibliothèques utilisées sont sous leurs propres licenses :
<ul>
<li> commons-lang : sous licence Apache (<A href = "http://commons.apache.org/lang/">homepage</A>)
<li> postgresql : sous licence BSD (<A href = "http://jdbc.postgresql.org/license.html">homepage</A>)
<li> args4j : MIT (<A href = "http://java.net/projects/args4j/">homepage</A>)
</ul>
Le présent logiciel est sous license <A href = "http://www.gnu.org/copyleft/gpl.html">GPLv3</A> 
</body>
</html>
