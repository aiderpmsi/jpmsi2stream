<?xml version="1.0" encoding="UTF-8" ?>

<scxml xmlns="http://www.w3.org/2005/07/scxml"
	xmlns:pims="http://custom.actions/pims"
	version="1.0" initial="test_header">

	<datamodel>
		<data name="numline" expr="1" />
	</datamodel>

	<state id="test_header">

		<onentry>
			<!-- Writes the line number -->
			<pims:execute expr="utils.writelinenumber(numline)" />

			<if cond="utils.isLine('rsf2012header')">

				<!-- RSF 2012 -->
				<pims:execute expr="utils.write('rsf2012header')" />
				<assign name="numline" expr="numline + 1" />
				<send event="'rsf2012h'" />
				
			<elseif cond="utils.isLine('rss116header')" />

				<!-- RSS 116 -->
				<pims:execute expr="utils.write('rss116header')" />
				<assign name="numline" expr="numline + 1" />
				<send event="'rss116h'" />
				
			<else />

				<!-- NONE -->
				<send event="'none'" />

			</if>

		</onentry>

		<transition event="rss116h" target="rss116h" />
		<transition event="rsf2012h" target="rsf2012h" />
		<transition event="none" target="headernotfound" />

	</state>

	<state id="headerrsf">

		<onentry>
			<!-- Writes the line number -->
			<pims:execute expr="utils.writelinenumber(numline)" />
			
			<if cond="utils.isLine('rsf2012header')">

				<!-- RSF 2012 -->
				<pims:execute expr="utils.write('rsf2012header')" />
				<assign name="numline" expr="numline + 1" />
				<send event="'rsf2012h'" />
				
			<else />

				<!-- None -->
				<send event="'none'" />

			</if>
		</onentry>

		<transition event="rsf2012h" target="rsf2012h" />
		<transition event="none" target="headernotfound" />

	</state>

	<state id="headerrss">

		<onentry>
			<!-- Writes the line number -->
			<pims:execute expr="utils.writelinenumber(numline)" />
			
			<if cond="utils.isLine('rss116header')">

				<pims:execute expr="utils.write('rss116header')" />
				<assign name="numline" expr="numline + 1" />
				<send event="'rss116h'" />
				
			<else />

				<!-- None -->
				<send event="'none'" />

			</if>
		</onentry>

		<transition event="rss116h" target="rss116h" />
		<transition event="none" target="headernotfound" />

	</state>

	<state id="rsf2012h">

		<initial>
			<transition target="rsf2012h.entry" />
		</initial>

		<state id="rsf2012h.entry">

			<onentry>
				
				<!-- Writes the line number -->
				<pims:execute expr="utils.writelinenumber(numline)" />
				
				<if cond="utils.isLine('rsf2012a')">
				
					<!-- RSF A -->
					<pims:execute expr="utils.write('rsf2012a')" />
					<assign name="numline" expr="numline + 1" />
					<send event="'rsf2012a'" />
					
				<elseif cond="utils.isLine('rsf2012b')" />

					<!-- RSF B -->
					<pims:execute expr="utils.write('rsf2012b')" />
					<assign name="numline" expr="numline + 1" />
					<send event="'rsf2012b'" />
					
				<elseif cond="utils.isLine('rsf2012c')" />

					<!-- RSF C -->
					<pims:execute expr="utils.write('rsf2012c')" />
					<assign name="numline" expr="numline + 1" />
					<send event="'rsf2012c'" />
					
				<elseif cond="utils.isLine('rsf2012h')" />

					<!-- RSF H -->
					<pims:execute expr="utils.write('rsf2012h')" />
					<assign name="numline" expr="numline + 1" />
					<send event="'rsf2012h'" />

				<elseif cond="utils.isLine('rsf2012i')" />

					<!-- RSF I -->
					<pims:execute expr="utils.write('rsf2012i')" />
					<assign name="numline" expr="numline + 1" />
					<send event="'rsf2012i'" />

				<elseif cond="utils.isLine('rsf2012l')" />

					<!-- RSF L -->
					<pims:execute expr="utils.write('rsf2012l')" />
					<assign name="numline" expr="numline + 1" />
					<send event="'rsf2012l'" />

				<elseif cond="utils.isLine('rsf2012m')" />

					<!-- RSF M -->
					<pims:execute expr="utils.write('rsf2012m')" />
					<assign name="numline" expr="numline + 1" />
					<send event="'rsf2012m'" />

				<elseif cond="utils.isLine('eof')" />

					<!-- EOF -->
					<pims:execute expr="utils.write('eof')" />
					<assign name="numline" expr="numline + 1" />
					<send event="'eof'" />

				<else />
				
					<!-- None -->
					<send event="'none'" />

				</if>
			</onentry>

			<transition event="rsf2012a" target="rsf2012h.entry" />
			<transition event="rsf2012b" target="rsf2012h.entry" />
			<transition event="rsf2012c" target="rsf2012h.entry" />
			<transition event="rsf2012h" target="rsf2012h.entry" />
			<transition event="rsf2012i" target="rsf2012h.entry" />
			<transition event="rsf2012l" target="rsf2012h.entry" />
			<transition event="rsf2012m" target="rsf2012h.entry" />
			<transition event="eof" target="eof" />
			<transition event="none" target="linenotknown" />
			
		</state>

	</state>

	<state id="rss116h">

		<datamodel>
			<data name="nbdaread" />
			<data name="nbdadread" />
			<data name="nbzaread" />
			<data name="nbda" />
			<data name="nbdad" />
			<data name="nbza" />
		</datamodel>

		<initial>
			<transition target="rss116h.entry" />
		</initial>

		<state id="rss116h.entry">

			<onentry>
				<!-- Init vars when reading a rss116 line -->
				<assign name="nbdaread" expr="0" />
				<assign name="nbdadread" expr="0" />
				<assign name="nbzaread" expr="0" />
				<assign name="nbda" expr="0" />
				<assign name="nbdad" expr="0" />
				<assign name="nbza" expr="0" />

				<if cond="utils.isLine('rsf20123')" >

					<!-- RSS 116 Main -->
					<!-- Writes the line number -->
					<pims:execute expr="utils.writelinenumber(numline)" />
					<!-- Writes the content of the RSS -->
					<pims:execute expr="utils.write('rss116main')" />
					<!-- Gets nb diags -->
					<assign name="nbda" expr="utils.getLine('rss116main').getInt(26)" />
					<assign name="nbdad" expr="utils.getLine('rss116main').getInt(27)" />
					<assign name="nbza" expr="utils.getLine('rss116main').getInt(28)" />
					<assign name="numline" expr="numline + 1" />
					<send event="'rss116main'" />
					
				<elseif cond="iseof" />

					<!-- EOF -->
					<pims:execute expr="utils.write('eof')" />
					<send event="'eof'" />
					
				<else />

					<!-- Unknown line -->
					<send event="'none'" />

				</if>
			</onentry>
	
			<transition event="rss116main" target="rss116h.main" />
			<transition event="eof" target="eof" />
			<transition event="none" target="linenotknown" />
			
		</state>

		<state id="rss116h.main">

			<onentry>

				<!-- Depending on what number of elements stay to read, read a da, a dad or za or nothing -->
				<if cond="nbdaread lt nbda">

					<!-- Some DA stay to be read -->
					<pims:execute expr="utils.isLine('rss116da')" />
					<pims:execute expr="utils.write'rss116da')" />

					<assign name="nbdaread" expr="nbdaread + 1" />
					<send event="'rss116da'" />

				<elseif cond="nbdadread lt nbdad" />

					<!-- Some DAD stay to be read -->
					<pims:execute expr="utils.isLine('rss116dad')" />
					<pims:execute expr="utils.write'rss116dad')" />

					<assign name="nbdadread" expr="nbdadread + 1" />
					<send event="'rss116dad'" />

				<elseif cond="nbzaread lt nbza" />

					<!-- Some ZA stay to be read -->
					<pims:execute expr="utils.isLine('rss116za')" />
					<pims:execute expr="utils.write'rss116za')" />

					<assign name="nbzaread" expr="nbzaread + 1" />
					<send event="'rss116za'" />

				<elseif	cond="(nbdaread eq nbda) and (nbdadread eq nbdad) and (nbzaread eq nbza)" />
				
					<!-- Nothing stays to be read -->
					<send event="'rssfinished'" />

				</if>
			</onentry>

			<!-- Transition map -->
			<transition event="rssfinished" target="rss116h" />
			<transition event="rss116da" target="rss116h.main" />
			<transition event="rss116dad" target="rss116h.main" />
			<transition event="rss116za" target="rss116h.main" />

		</state>

	</state>

	<state id="headernotfound" final="true">
		<onentry>
			<pims:execute expr="utils.error(Pas d'entÃªte valide retrouvee, numline)" />
		</onentry>
	</state>
	
	<state id="linenotknown" final="true">
		<onentry>
			<pims:execute expr="utils.error(Ligne non reconnue, numline)" />
		</onentry>
	</state>
	
	<state id="eof" final="true" />

</scxml>