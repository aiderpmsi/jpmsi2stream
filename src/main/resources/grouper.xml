<?xml version="1.0" encoding="UTF-8" ?>

<scxml xmlns="http://www.w3.org/2005/07/scxml"
	xmlns:my="http://my.custom-actions.domain/CUSTOM"
	version="1.0" initial="group">

	<state id="group">

		<initial>
	    	<transition target="test_cmd28"/>
		</initial>
	
		<!-- TEST IF WE ARE IN CMD 28 -->
		<state id="test_cmd28">
			<onentry>
				<my:fromRss domain="main" get="NbSeances" result="numSeances" pattern="{0}" type="Integer" />
				<if cond="numSeances != 0">
					<send event="'cmd_found'" />
					<else />
					<send event="'cmd_not_found'" />
				</if>
			</onentry>
			
			<transition event="cmd_found" target="process_cmd28" />
			<transition event="cmd_not_found" target="test_cmd27" />
	
		</state>

		<!-- TEST IF WE ARE IN CMD 27 -->
		<state id="test_cmd27">
			<onentry>
				<my:fromRss domain="acte" get="CodeCCAM,Phase" pattern="{0}/{1}" result="acte" type="String"/>
				<my:isInResource resource="acteclassant" key="27" value="acte" result="acte_cmd27"/>
				<my:isInResource resource="classeacte" key="ADC" value="acte" result="acte_adc"/>
				<my:isInResource resource="unclassified" key="A-138" value="acte" result="a138"/>
				<if cond="acte_cmd27 and acte_adc">
					<send event="'cmd_27_adc'" />
					<elseif cond="a138"/>
					<send event="'a138'" />
					<else />
					<send event="'cmd_not_found'" />
				</if>
			</onentry>
			
			<transition event="cmd_27_adc" target="process_cmd27_adc" />
			<transition event="a138" target="process_cmd27_a138" />
			<transition event="cmd_not_found" target="fend" /> <!-- To continue -->
	
		</state>

		<!-- WE ARE IN CMD28 -->
		<state id="process_cmd28">
			<onentry>
				<my:fromRss domain="main" get="DP" pattern="{0}" result="dp" type="Diagnostic" />
				<my:isInResource resource="unclassified" key="D-145" value="dp" result="d145"/>
				<if cond="d145">
				<send event="'d145_found'" />
					<else />
					<my:group erreur="90Z01Z" />
					<send event="'end'" />
				</if>
			</onentry>
			
			<transition event="d145_found" target="process_cmd28_d145" />
			<transition event="end" target="end" />

		</state>

		<!-- WE ARE IN CMD28 AND D145 -->
		<state id="process_cmd28_d145">
			<onentry>
				<my:fromRss domain="main" get="DP" result="dp" pattern="{0}" type="Diagnostic" />
				<my:isInResource resource="unclassified" key="D-113" value="dp" result="d113" />
				<my:isInResource resource="unclassified" key="D-114" value="dp" result="d114" />
				<my:isInResource resource="unclassified" key="D-063" value="dp" result="d063" />
				<my:isInResource resource="unclassified" key="D-142" value="dp" result="d142" />
				<my:isInResource resource="unclassified" key="D-143" value="dp" result="d143" />
				<my:isInResource resource="unclassified" key="D-139" value="dp" result="d139" />
				<my:isInResource resource="unclassified" key="D-047" value="dp" result="d047" />
				<my:isInResource resource="unclassified" key="D-054" value="dp" result="d054" />
				<if cond="d113" >
					<send event="'d113_found'" />
					<elseif cond="d114" />
					<my:group racine="28Z07" gravite="Z"/>
					<send event="'end'" />
					<elseif cond="d063" />
					<my:group racine="28Z17" gravite="Z"/>
					<send event="'end'" />
					<elseif cond="d142" />
					<send event="'d142_found'" />
					<elseif cond="d143" />
					<send event="'d143_found'" />
					<elseif cond="d139" />
					<my:group racine="28Z14" gravite="Z"/>
					<send event="'end'" />
					<elseif cond="d047" />
					<my:group racine="28Z15" gravite="Z"/>
					<send event="'end'" />
					<elseif cond="d054" />
					<my:group racine="28Z16" gravite="Z"/>
					<send event="'end'" />
					<else />
					<my:group erreur="90Z02Z" />
					<send event="'end'" />
				</if>
			</onentry>
			
			<transition event="d113_found" target="process_cmd28_d145_d113" />
			<transition event="d142_found" target="process_cmd28_d145_d142" />
			<transition event="d143_found" target="process_cmd28_d145_d143" />
			<transition event="end" target="end" />

		</state>					
		
		<!-- We are in CMD 28, D-145 and D-113 -->
		<state id="process_cmd28_d145_d113">
			<onentry>
				<my:fromRss domain="main"  get="DP" result="dp" pattern="{0}" type="Diagnostic" />
				<my:fromRss domain="acte" get="CodeCCAM,Phase" pattern="{0}/{1}" result="acte" type="String"/>
				<my:isInResource resource="unclassified" key="A-180" value="acte" result="a180" />
				<my:isInResource resource="unclassified" key="A-181" value="acte" result="a181" />
				<my:isInResource resource="unclassified" key="A-234" value="acte" result="a234" />
				<my:isInResource resource="unclassified" key="D-030" value="dp" result="d030" />
				<if cond="a180" >
					<my:group racine="28Z01" gravite="Z" />
					<send event="'end'" />
					<elseif cond="a181" />
					<my:group racine="28Z02" gravite="Z" />
					<send event="'end'" />
					<elseif cond="a234" />
					<my:group racine="28Z03" gravite="Z" />
					<send event="'end'" />
					<elseif cond="d030" />
					<my:group racine="28Z04" gravite="Z" />
					<send event="'end'" />
					<else />
					<my:group erreur="90Z02Z" />
					<send event="'end'" />
				</if>
			</onentry>
			
			<transition event="end" target="end" />
			
		</state>

		<!-- We are in CMD 28, D-145 and D-142 -->
		<state id="process_cmd28_d145_d142">
			<onentry>
				<my:fromRss domain="main" get="DP" result="dp" pattern="{0}" type="Diagnostic" />
				<my:fromRss domain="acte" get="CodeCCAM,Phase" pattern="{1}/{2}" result="acte" type="String"/>
				<my:isInResource resource="unclassified" key="A-314" value="acte" result="a314" />
				<my:isInResource resource="unclassified" key="A-315" value="acte" result="a315" />
				<my:isInResource resource="unclassified" key="A-316" value="acte" result="a316" />
				<my:isInResource resource="unclassified" key="A-317" value="dp" result="a317" />
				<if cond="a314" >
					<my:group racine="28Z19" gravite="Z" />
					<send event="'end'" />
					<elseif cond="a315" />
					<my:group racine="28Z20" gravite="Z"/>
					<send event="'end'" />
					<elseif cond="a316" />
					<my:group racine="28Z21" gravite="Z" />
					<send event="'end'" />
					<elseif cond="a317" />
					<my:group racine="28Z22" gravite="Z" />
					<send event="'end'" />
					<else />
					<my:group erreur="90Z02Z" />
					<send event="'end'" />
				</if>
			</onentry>

			<transition event="end" target="end" />

		</state>
	
		<!-- We are in CMD 28, D-145 and D-143 -->
		<state id="process_cmd28_d145_d143" >
			<onentry>
				<my:fromRss domain="acte" get="CodeCCAM,Phase" pattern="{1}/{2}" result="acte" type="String"/>
				<my:isInResource resource="unclassified" key="A-342" value="acte" result="a342" />
				<my:isInResource resource="unclassified" key="A-205" value="acte" result="a205" />
				<my:isInResource resource="unclassified" key="A-170" value="acte" result="a170" />
				<my:isInResource resource="unclassified" key="A-304" value="acte" result="a304" />
				<my:isInResource resource="unclassified" key="A-318" value="acte" result="a318" />
				<my:isInResource resource="unclassified" key="A-319" value="acte" result="a319" />
				<my:isInResource resource="unclassified" key="A-320" value="acte" result="a320" />
				<if cond="a342" >
					<send event="'fend'" /> <!-- test_cmd27 -->
					<elseif cond="a205" />
					<my:group racine="28Z10" gravite="Z" />
					<send event="'end'" />
					<elseif cond="a170" />
					<my:group racine="28Z11" gravite="Z" />
					<send event="'end'" />
					<elseif cond="a304" />
					<my:group racine="28Z18" gravite="Z" />
					<send event="'end'" />
					<elseif cond="a318" />
					<my:group racine="28Z23" gravite="Z" />
					<send event="'end'" />
					<else />
					<elseif cond="a319" />
					<my:group racine="28Z24" gravite="Z" />
					<send event="'end'" />
					<elseif cond="a320" />
					<my:group racine="28Z25" gravite="Z" />
					<send event="'end'" />
					<else />
					<my:group erreur="90Z02Z" />
					<send event="'end'" />
				</if>
			</onentry>

			<transition event="end" target="end" />

		</state>

		<!-- WE ARE IN CMD27 AND IN ADC -->
		<state id="process_cmd27_adc">
			<onentry>
				<my:fromRss domain="acte" get="CodeCCAM,Phase" pattern="{0}/{1}" result="acte" type="String"/>
				<my:isInResource resource="unclassified" key="A-139" value="acte" result="a139"/>
				<my:isInResource resource="unclassified" key="A-140" value="acte" result="a140"/>
				<my:isInResource resource="unclassified" key="A-141" value="acte" result="a141"/>
				<my:isInResource resource="unclassified" key="A-027" value="acte" result="a027"/>
				<my:isInResource resource="unclassified" key="A-093" value="acte" result="a093"/>
				<my:isInResource resource="unclassified" key="A-265" value="acte" result="a265"/>
				<if cond="a139">
					<my:group racine="27C02" gravite="1" />
					<send event="'end'" />
					<elseif cond="a140"/>
					<my:group racine="27C03" gravite="1" />
					<send event="'end'" />
					<elseif cond="a141" />
					<my:group racine="27C04" gravite="1" />
					<send event="'end'" />
					<elseif cond="a027" />
					<my:group racine="27C05" gravite="1" />
					<send event="'end'" />
					<elseif cond="a093" />
					<my:group racine="27C06" gravite="1" />
					<send event="'end'" />
					<elseif cond="a265" />
					<my:group racine="27C07" gravite="1" />
					<send event="'end'" />
					<else />
					<my:group erreur="90Z02Z" />
					<send event="'end'" />
				</if>
			</onentry>
			
			<transition event="end" target="end" />

		</state>
		
		<!-- WE ARE IN CMD27 AND A-138 -->

	</state>

	<state id="end" final="true" />

	<state id="fend" finale="true" />
	
</scxml>